version: "3.7"
services:
  metabase-db:
    image: mysql:5.7
    volumes:
      - metabase_mysql_data:/var/lib/mysql
    restart: unless-stopped
#    ports:
#      - "3307:3306"
    networks:
      - metabase
    environment:
      MYSQL_ROOT_PASSWORD: metabase
      MYSQL_DATABASE: metabase
      MYSQL_USER: metabase
      MYSQL_PASSWORD: metabase
  metabase-app:
    image: softasap/metabase:202309141500
#    ports:
#      - 3001:3000
    volumes:
# declare your mount volume /host/dir:/container/dir
    - metabase_data:/metabase-data
    - ./csv:/csv
    networks:
      - metabase
      - traefik-public
    environment:
      MB_DB_TYPE: mysql
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 3306
      MB_DB_USER: metabase
      MB_DB_PASS: metabase
      MB_DB_HOST: metabase-db
    depends_on:
      - metabase-db
    links:
      - metabase-db
    labels:
      - "traefik.enable=true"
      # New v3 routers with priority
      - "traefik.http.routers.metabase-v3.rule=Host(`mb.lvh.voronenko.net`)"
      - "traefik.http.routers.metabase-v3.ruleSyntax=v3"
      - "traefik.http.routers.metabase-v3.entrypoints=web"
      - "traefik.http.routers.metabase-v3.priority=100"

      # Existing v2 routers (kept as fallback)
      - "traefik.http.routers.metabase.rule=Host(`mb.lvh.voronenko.net`)"
      - "traefik.http.routers.metabase.entrypoints=web"

#      - "traefik.http.middlewares.traefik-auth.basicauth.users=USER:PASSWORD"
#      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"
#      - "traefik.http.routers.traefik.middlewares=traefik-https-redirect"

      # New v3 secure router
      - "traefik.http.routers.metabase-secure-v3.entrypoints=websecure"
      - "traefik.http.routers.metabase-secure-v3.rule=Host(`mb.lvh.voronenko.net`)"
      - "traefik.http.routers.metabase-secure-v3.ruleSyntax=v3"
      - "traefik.http.routers.metabase-secure-v3.tls=true"
      - "traefik.http.routers.metabase-secure-v3.priority=100"

      # Existing v2 secure router
      - "traefik.http.routers.metabase-secure.entrypoints=websecure"
      - "traefik.http.routers.metabase-secure.rule=Host(`mb.lvh.voronenko.net`)"
#      - "traefik.http.routers.metabase-secure.middlewares=traefik-auth"
      - "traefik.http.routers.metabase-secure.tls=true"

volumes:
  metabase_mysql_data: {}
  metabase_data: {}

networks:
  metabase:
  traefik-public:
    external: true

